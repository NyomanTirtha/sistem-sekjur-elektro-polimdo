generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Tambahkan model Jurusan untuk mengelompokkan Program Studi
model Jurusan {
  id           Int            @id @default(autoincrement())
  nama         String         @unique // contoh: "Teknik Elektro", "Teknik Informatika", "Teknik Sipil"
  programStudi ProgramStudi[]
  users        User[]         // Relasi ke User untuk sekretaris jurusan

  @@map("jurusan")
}

model User {
  id             Int           @id @default(autoincrement())
  username       String        @unique
  nama           String
  password       String
  role           UserRole
  jurusanId      Int?
  programStudiId Int?
  jurusan        Jurusan?      @relation(fields: [jurusanId], references: [id])
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  @@index([jurusanId])
  @@index([programStudiId])
  @@map("users")
}

model ProgramStudi {
  id         Int         @id @default(autoincrement())
  nama       String
  ketuaProdi String
  jurusanId  Int
  jurusan    Jurusan     @relation(fields: [jurusanId], references: [id])
  dosen      Dosen[]
  mahasiswa  Mahasiswa[]
  mataKuliah MataKuliah[]
  kaprodiUsers User[]

  @@index([jurusanId])
  @@map("program_studi")
}

model Mahasiswa {
  nim            String        @id
  nama           String
  programStudiId Int
  angkatan       String?
  semester       Int?
  noTelp         String?
  alamat         String?
  programStudi   ProgramStudi  @relation(fields: [programStudiId], references: [id])
  pengajuanSA    PengajuanSA[]

  @@index([programStudiId], map: "mahasiswa_programStudiId_fkey")
  @@map("mahasiswa")
}

model Dosen {
  nip                String              @id
  nama               String
  prodiId            Int
  noTelp             String?
  alamat             String?
  isKaprodi          Boolean             @default(false)
  prodi              ProgramStudi        @relation(fields: [prodiId], references: [id])
  pengajuanSADetails PengajuanSADetail[]
  penugasanMengajar  PenugasanMengajar[]

  @@index([prodiId], map: "dosen_prodiId_fkey")
  @@map("dosen")
}

model MataKuliah {
  id               Int                 @id @default(autoincrement())
  nama             String
  sks              Int
  semester         Int
  programStudiId   Int                 // Tambahkan relasi ke ProgramStudi
  programStudi     ProgramStudi        @relation(fields: [programStudiId], references: [id])
  pengajuanDetails PengajuanSADetail[]
  penugasanMengajar  PenugasanMengajar[]

  @@index([programStudiId])
  @@map("mata_kuliah")
}

model PengajuanSA {
  id               Int                 @id @default(autoincrement())
  mahasiswaId      String
  buktiPembayaran  String
  tanggalPengajuan DateTime            @default(now())
  semesterPengajuan Int
  status           StatusSA            @default(PROSES_PENGAJUAN)
  keterangan       String?
  keteranganReject String?
  nominal          Decimal             @db.Decimal(10, 2)
  mahasiswa        Mahasiswa           @relation(fields: [mahasiswaId], references: [nim])
  details          PengajuanSADetail[]

  @@index([mahasiswaId], map: "pengajuan_sa_mahasiswaId_fkey")
  @@map("pengajuan_sa")
}

model PengajuanSADetail {
  id            Int         @id @default(autoincrement())
  pengajuanSAId Int
  mataKuliahId  Int
  dosenId       String?
  nilaiAkhir    Float?
  dosen         Dosen?      @relation(fields: [dosenId], references: [nip])
  mataKuliah    MataKuliah  @relation(fields: [mataKuliahId], references: [id])
  pengajuanSA   PengajuanSA @relation(fields: [pengajuanSAId], references: [id], onDelete: Cascade)

  @@index([pengajuanSAId], map: "pengajuan_sa_detail_pengajuanSAId_fkey")
  @@index([mataKuliahId], map: "pengajuan_sa_detail_mataKuliahId_fkey")
  @@index([dosenId], map: "pengajuan_sa_detail_dosenId_fkey")
  @@map("pengajuan_sa_detail")
}

enum UserRole {
  SEKJUR         // Sekretaris Jurusan (dulu ADMIN)
  MAHASISWA      // Mahasiswa
  DOSEN          // Dosen
  KAPRODI        // Ketua Program Studi
}

enum StatusSA {
  PROSES_PENGAJUAN
  MENUNGGU_VERIFIKASI_KAPRODI
  DALAM_PROSES_SA
  SELESAI
  DITOLAK
}

enum StatusPenugasan {
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  CANCELLED
}

model PenugasanMengajar {
  id                Int              @id @default(autoincrement())
  mataKuliahId      Int
  dosenId           String
  tahunAjaran       String
  semester          Int
  status            StatusPenugasan   @default(PENDING_APPROVAL)
  assignedBy        String            // "DOSEN" atau "KAPRODI"
  assignedById      String            // NIP dosen atau username kaprodi
  requestedBy       String?           // Jika dosen yang request, simpan NIP-nya
  approvedBy        String?           // Jika kaprodi approve, simpan username-nya
  approvedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  mataKuliah        MataKuliah       @relation(fields: [mataKuliahId], references: [id])
  dosen             Dosen             @relation(fields: [dosenId], references: [nip])

  @@unique([mataKuliahId, tahunAjaran, semester])
  @@index([dosenId])
  @@index([status])
  @@map("penugasan_mengajar")
}