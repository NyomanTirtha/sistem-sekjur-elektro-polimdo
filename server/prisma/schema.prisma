generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Tambahkan model Jurusan untuk mengelompokkan Program Studi
model Jurusan {
  id           Int            @id @default(autoincrement())
  nama         String         @unique // contoh: "Teknik Elektro", "Teknik Informatika", "Teknik Sipil"
  programStudi ProgramStudi[]
  users        User[]         // Relasi ke User untuk sekretaris jurusan

  @@map("jurusan")
}

model User {
  id             Int           @id @default(autoincrement())
  username       String        @unique
  nama           String
  password       String
  role           UserRole
  jurusanId      Int?
  programStudiId Int?
  jurusan        Jurusan?      @relation(fields: [jurusanId], references: [id])
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  @@index([jurusanId])
  @@index([programStudiId])
  @@map("users")
}

model ProgramStudi {
  id         Int         @id @default(autoincrement())
  nama       String
  ketuaProdi String
  jurusanId  Int
  jurusan    Jurusan     @relation(fields: [jurusanId], references: [id])
  dosen      Dosen[]
  mahasiswa  Mahasiswa[]
  mataKuliah MataKuliah[]
  kaprodiUsers User[]
  prodiSchedules ProdiSchedule[]

  @@index([jurusanId])
  @@map("program_studi")
}

model Mahasiswa {
  nim            String        @id
  nama           String
  programStudiId Int
  angkatan       String?
  semester       Int?
  noTelp         String?
  alamat         String?
  programStudi   ProgramStudi  @relation(fields: [programStudiId], references: [id])
  pengajuanSA    PengajuanSA[]

  @@index([programStudiId], map: "mahasiswa_programStudiId_fkey")
  @@map("mahasiswa")
}

model Dosen {
  nip                String              @id
  nama               String
  prodiId            Int
  noTelp             String?
  alamat             String?
  isKaprodi          Boolean             @default(false)
  prodi              ProgramStudi        @relation(fields: [prodiId], references: [id])
  pengajuanSADetails PengajuanSADetail[]
  penugasanMengajar  PenugasanMengajar[]
  scheduleItems      ScheduleItem[]
  dosenRequests      DosenScheduleRequest[]

  @@index([prodiId], map: "dosen_prodiId_fkey")
  @@map("dosen")
}

model MataKuliah {
  id               Int                 @id @default(autoincrement())
  nama             String
  sks              Int
  semester         Int
  programStudiId   Int                 // Tambahkan relasi ke ProgramStudi
  programStudi     ProgramStudi        @relation(fields: [programStudiId], references: [id])
  pengajuanDetails PengajuanSADetail[]
  penugasanMengajar  PenugasanMengajar[]
  scheduleItems      ScheduleItem[]
  dosenRequests      DosenScheduleRequest[]

  @@index([programStudiId])
  @@map("mata_kuliah")
}

model PengajuanSA {
  id               Int                 @id @default(autoincrement())
  mahasiswaId      String
  buktiPembayaran  String
  tanggalPengajuan DateTime            @default(now())
  semesterPengajuan Int
  status           StatusSA            @default(PROSES_PENGAJUAN)
  keterangan       String?
  keteranganReject String?
  nominal          Decimal             @db.Decimal(10, 2)
  mahasiswa        Mahasiswa           @relation(fields: [mahasiswaId], references: [nim])
  details          PengajuanSADetail[]

  @@index([mahasiswaId], map: "pengajuan_sa_mahasiswaId_fkey")
  @@map("pengajuan_sa")
}

model PengajuanSADetail {
  id            Int         @id @default(autoincrement())
  pengajuanSAId Int
  mataKuliahId  Int
  dosenId       String?
  nilaiAkhir    Float?
  dosen         Dosen?      @relation(fields: [dosenId], references: [nip])
  mataKuliah    MataKuliah  @relation(fields: [mataKuliahId], references: [id])
  pengajuanSA   PengajuanSA @relation(fields: [pengajuanSAId], references: [id], onDelete: Cascade)

  @@index([pengajuanSAId], map: "pengajuan_sa_detail_pengajuanSAId_fkey")
  @@index([mataKuliahId], map: "pengajuan_sa_detail_mataKuliahId_fkey")
  @@index([dosenId], map: "pengajuan_sa_detail_dosenId_fkey")
  @@map("pengajuan_sa_detail")
}

enum UserRole {
  SEKJUR         // Sekretaris Jurusan (dulu ADMIN)
  MAHASISWA      // Mahasiswa
  DOSEN          // Dosen
  KAPRODI        // Ketua Program Studi
}

enum StatusSA {
  PROSES_PENGAJUAN
  MENUNGGU_VERIFIKASI_KAPRODI
  DALAM_PROSES_SA
  SELESAI
  DITOLAK
}

enum StatusPenugasan {
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  CANCELLED
}

model PenugasanMengajar {
  id                Int              @id @default(autoincrement())
  mataKuliahId      Int
  dosenId           String
  tahunAjaran       String
  semester          Int
  status            StatusPenugasan   @default(PENDING_APPROVAL)
  assignedBy        String            // "DOSEN" atau "KAPRODI"
  assignedById      String            // NIP dosen atau username kaprodi
  requestedBy       String?           // Jika dosen yang request, simpan NIP-nya
  approvedBy        String?           // Jika kaprodi approve, simpan username-nya
  approvedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  mataKuliah        MataKuliah       @relation(fields: [mataKuliahId], references: [id])
  dosen             Dosen             @relation(fields: [dosenId], references: [nip])

  @@unique([mataKuliahId, tahunAjaran, semester])
  @@index([dosenId])
  @@index([status])
  @@map("penugasan_mengajar")
}

// =====================================================
// SISTEM JADWAL/TIMETABLE MODELS
// =====================================================

model TimetablePeriod {
  id              Int             @id @default(autoincrement())
  semester        SemesterType
  tahunAkademik   String          // format: "2024/2025"
  status          PeriodStatus    @default(DRAFT)
  createdBySekjur String          // username sekjur yang buat
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  prodiSchedules  ProdiSchedule[]

  @@unique([semester, tahunAkademik])
  @@map("timetable_periods")
}

model Ruangan {
  id           Int             @id @default(autoincrement())
  nama         String          @unique // "A101", "LAB1", dll
  kapasitas    Int
  fasilitas    String?         // "Proyektor, AC, Whiteboard"
  lokasi       String?         // "Gedung A, Lantai 1"
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  scheduleItems     ScheduleItem[]
  dosenRequests     DosenScheduleRequest[]

  @@map("ruangan")
}

model ProdiSchedule {
  id                 Int             @id @default(autoincrement())
  timetablePeriodId  Int
  prodiId            Int
  kaprodiId          String          // username kaprodi
  kelas              String          // Nama kelas (contoh: "1TI1", "2TL2")
  status             ScheduleStatus  @default(DRAFT)
  submittedAt        DateTime?
  approvedAt         DateTime?
  sekjurNotes        String?         // catatan dari sekjur
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  timetablePeriod    TimetablePeriod @relation(fields: [timetablePeriodId], references: [id], onDelete: Cascade)
  prodi              ProgramStudi    @relation(fields: [prodiId], references: [id])
  scheduleItems      ScheduleItem[]
  revisions          ScheduleRevision[]

  @@unique([timetablePeriodId, prodiId, kelas])
  @@index([prodiId])
  @@index([status])
  @@index([kelas])
  @@map("prodi_schedules")
}

model ScheduleItem {
  id                Int           @id @default(autoincrement())
  prodiScheduleId   Int
  mataKuliahId      Int
  dosenId           String
  hari              HariType
  jamMulai          String        // format: "08:00"
  jamSelesai        String        // format: "10:30"
  ruanganId         Int
  kelas             String?       // "A1", "B2", dll
  kapasitasMahasiswa Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  prodiSchedule     ProdiSchedule @relation(fields: [prodiScheduleId], references: [id], onDelete: Cascade)
  mataKuliah        MataKuliah    @relation(fields: [mataKuliahId], references: [id])
  dosen             Dosen         @relation(fields: [dosenId], references: [nip])
  ruangan           Ruangan       @relation(fields: [ruanganId], references: [id])

  @@index([prodiScheduleId])
  @@index([mataKuliahId])
  @@index([dosenId])
  @@index([ruanganId])
  @@index([hari])
  @@map("schedule_items")
}

model DosenScheduleRequest {
  id                    Int               @id @default(autoincrement())
  dosenId               String
  kaprodiId             String            // username kaprodi tujuan
  mataKuliahId          Int
  preferredHari         HariType
  preferredJamMulai     String            // format: "08:00"
  preferredJamSelesai   String            // format: "10:30"
  preferredRuanganId    Int?
  preferredKelas        String?           // Kelas yang dipilih dosen (contoh: "1TI1", "2TL2")
  alasanRequest         String
  status                RequestStatus     @default(PENDING)
  kaprodiNotes          String?
  submittedAt           DateTime          @default(now())
  processedAt           DateTime?

  dosen                 Dosen             @relation(fields: [dosenId], references: [nip])
  mataKuliah            MataKuliah        @relation(fields: [mataKuliahId], references: [id])
  preferredRuangan      Ruangan?          @relation(fields: [preferredRuanganId], references: [id])

  @@index([dosenId])
  @@index([mataKuliahId])
  @@index([status])
  @@index([preferredKelas])
  @@map("dosen_schedule_requests")
}

model ScheduleRevision {
  id                Int           @id @default(autoincrement())
  prodiScheduleId   Int
  revisionNotes     String
  createdBySekjur   String        // username sekjur
  createdAt         DateTime      @default(now())

  prodiSchedule     ProdiSchedule @relation(fields: [prodiScheduleId], references: [id], onDelete: Cascade)

  @@index([prodiScheduleId])
  @@map("schedule_revisions")
}

// =====================================================
// ENUMS UNTUK SISTEM JADWAL
// =====================================================

enum SemesterType {
  GANJIL
  GENAP
  ANTARA
}

enum PeriodStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum ScheduleStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
}

enum HariType {
  SENIN
  SELASA
  RABU
  KAMIS
  JUMAT
  SABTU
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}
